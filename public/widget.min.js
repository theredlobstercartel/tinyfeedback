/* TinyFeedback Widget v1.0.0 | https://tinyfeedback.vercel.app */
(function(){'use strict';function getApiUrl(){const scripts = document.querySelectorAll('script[src*="widget.js"]');for(const script of scripts){const src = script.src;if(src){try{const url = new URL(src);return `${url.protocol}}catch(e){}}}return 'https:}const CONFIG ={apiUrl:getApiUrl(),defaultPosition:'bottom-right',defaultColor:'#00ff88',};const widgetInstances = new Map();class TinyFeedbackWidget{constructor(config){this.config ={projectId:config.project_id,apiKey:config.api_key,position:config.position || CONFIG.defaultPosition,primaryColor:config.primaryColor || CONFIG.defaultColor,title:config.title || 'Queremos seu feedback!',subtitle:config.subtitle || '',thankYouMessage:config.thankYouMessage || 'Obrigado pelo feedback!',enableNps:config.enableNps !== false,enableSuggestions:config.enableSuggestions !== false,enableBugs:config.enableBugs !== false,};this.isOpen = false;this.currentStep = 1;this.selectedNps = null;this.feedbackType = null;this.feedbackTitle = '';this.init();}init(){this.createShadowDOM();this.injectStyles();this.createButton();this.createModal();}createShadowDOM(){this.host = document.createElement('div');this.host.id = `tinyfeedback-widget-host-${Date.now()}`;this.shadow = this.host.attachShadow({mode:'open'});document.body.appendChild(this.host);}injectStyles(){const styles = ` *{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;}.tf-widget-button{position:fixed;${this.getPositionStyles()}width:56px;height:56px;border-radius:0;background:${this.config.primaryColor};border:2px solid ${this.config.primaryColor};cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(0,0,0,0.5),0 0 30px ${this.config.primaryColor}40,inset 0 0 20px rgba(255,255,255,0.1);transition:all 0.2s ease;z-index:2147483647;}.tf-widget-button:hover{transform:translateY(-2px)scale(1.05);box-shadow:0 6px 30px rgba(0,0,0,0.6),0 0 50px ${this.config.primaryColor}60,inset 0 0 30px rgba(255,255,255,0.2);background:${this.lightenColor(this.config.primaryColor,10)};}.tf-widget-button:active{transform:translateY(0)scale(1);}.tf-widget-button svg{width:24px;height:24px;color:#0a0a0a;filter:drop-shadow(0 0 4px rgba(0,0,0,0.3));}.tf-modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:2147483647;opacity:0;transition:opacity 0.25s ease;}.tf-modal-overlay.active{display:flex;opacity:1;}.tf-modal{background:linear-gradient(145deg,#1a1a1a 0%,#0d0d0d 100%);border:1px solid ${this.config.primaryColor}40;border-radius:0;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,0.8),0 0 60px ${this.config.primaryColor}20,inset 0 1px 0 rgba(255,255,255,0.05);transform:scale(0.95)translateY(10px);transition:transform 0.25s cubic-bezier(0.34,1.56,0.64,1);}.tf-modal-overlay.active .tf-modal{transform:scale(1)translateY(0);}.tf-modal-header{padding:24px 24px 16px;border-bottom:1px solid ${this.config.primaryColor}30;display:flex;justify-content:space-between;align-items:flex-start;background:linear-gradient(180deg,rgba(255,255,255,0.03)0%,transparent 100%);}.tf-modal-title{color:#fff;font-size:20px;font-weight:600;margin:0;text-shadow:0 0 20px ${this.config.primaryColor}40;}.tf-modal-subtitle{color:#888;font-size:14px;margin-top:4px;}.tf-close-btn{background:none;border:none;color:#666;cursor:pointer;padding:4px;display:flex;align-items:center;justify-content:center;transition:all 0.2s;border-radius:0;}.tf-close-btn:hover{color:${this.config.primaryColor};transform:rotate(90deg);}.tf-modal-body{padding:24px;}.tf-step-label{color:#888;font-size:14px;margin-bottom:16px;}.tf-nps-scale{display:flex;gap:6px;justify-content:center;margin:16px 0;flex-wrap:wrap;}.tf-nps-btn{width:36px;height:36px;border:1px solid #333;background:#0a0a0a;color:#fff;font-size:13px;font-weight:500;cursor:pointer;transition:all 0.15s;display:flex;align-items:center;justify-content:center;border-radius:0;}.tf-nps-btn:hover{border-color:${this.config.primaryColor};background:#1a1a1a;box-shadow:0 0 10px ${this.config.primaryColor}30;}.tf-nps-btn.selected{background:${this.config.primaryColor};border-color:${this.config.primaryColor};color:#0a0a0a;font-weight:600;box-shadow:0 0 20px ${this.config.primaryColor}50;}.tf-nps-labels{display:flex;justify-content:space-between;color:#555;font-size:12px;margin-top:8px;}.tf-type-buttons{display:flex;gap:12px;margin:16px 0;}.tf-type-btn{flex:1;padding:16px 12px;border:1px solid #333;background:linear-gradient(145deg,#0f0f0f 0%,#0a0a0a 100%);color:#fff;cursor:pointer;font-size:14px;transition:all 0.15s;display:flex;flex-direction:column;align-items:center;gap:8px;border-radius:0;}.tf-type-btn:hover{border-color:${this.config.primaryColor}60;background:linear-gradient(145deg,#1a1a1a 0%,#0f0f0f 100%);box-shadow:0 0 20px ${this.config.primaryColor}20;}.tf-type-btn.selected{background:${this.config.primaryColor};border-color:${this.config.primaryColor};color:#0a0a0a;font-weight:600;box-shadow:0 0 30px ${this.config.primaryColor}40;}.tf-type-btn.selected svg{color:#0a0a0a;}.tf-textarea{width:100%;min-height:120px;padding:12px;border:1px solid #333;background:#0a0a0a;color:#fff;font-size:14px;resize:vertical;margin:16px 0;border-radius:0;transition:all 0.2s;}.tf-textarea:focus{outline:none;border-color:${this.config.primaryColor};box-shadow:0 0 15px ${this.config.primaryColor}20,inset 0 0 10px rgba(0,0,0,0.5);}.tf-textarea::placeholder{color:#555;}.tf-title-input{width:100%;padding:12px;border:1px solid #333;background:#0a0a0a;color:#fff;font-size:14px;margin-bottom:12px;border-radius:0;transition:all 0.2s;}.tf-title-input:focus{outline:none;border-color:${this.config.primaryColor};box-shadow:0 0 15px ${this.config.primaryColor}20;}.tf-title-input::placeholder{color:#555;}.tf-submit-btn{width:100%;padding:14px;background:${this.config.primaryColor};border:2px solid ${this.config.primaryColor};color:#0a0a0a;font-size:15px;font-weight:600;cursor:pointer;transition:all 0.2s;border-radius:0;text-transform:uppercase;letter-spacing:0.5px;box-shadow:0 4px 15px ${this.config.primaryColor}30;}.tf-submit-btn:hover:not(:disabled){filter:brightness(1.1);box-shadow:0 6px 25px ${this.config.primaryColor}50;transform:translateY(-1px);}.tf-submit-btn:disabled{opacity:0.4;cursor:not-allowed;filter:grayscale(0.5);}.tf-success{text-align:center;padding:48px 24px;}.tf-success-icon{width:64px;height:64px;color:${this.config.primaryColor};margin:0 auto 20px;filter:drop-shadow(0 0 20px ${this.config.primaryColor}50);animation:tf-pulse 2s ease-in-out infinite;}@keyframes tf-pulse{0%,100%{transform:scale(1);opacity:1;}50%{transform:scale(1.05);opacity:0.9;}}.tf-success-title{color:#fff;font-size:24px;font-weight:600;margin-bottom:8px;text-shadow:0 0 20px ${this.config.primaryColor}30;}.tf-success-message{color:#888;font-size:15px;line-height:1.5;}.tf-hidden{display:none !important;}.tf-modal::-webkit-scrollbar{width:8px;}.tf-modal::-webkit-scrollbar-track{background:#0a0a0a;}.tf-modal::-webkit-scrollbar-thumb{background:#333;border-radius:0;}.tf-modal::-webkit-scrollbar-thumb:hover{background:${this.config.primaryColor}60;}.tf-loading{display:inline-block;width:20px;height:20px;border:2px solid rgba(0,0,0,0.3);border-top-color:#0a0a0a;border-radius:50%;animation:tf-spin 0.8s linear infinite;margin-right:8px;vertical-align:middle;}@keyframes tf-spin{to{transform:rotate(360deg);}}`;const styleEl = document.createElement('style');styleEl.textContent = styles;this.shadow.appendChild(styleEl);}lightenColor(color,percent){const num = parseInt(color.replace('#',''),16);const amt = Math.round(2.55 * percent);const R =(num >> 16)+ amt;const G =(num >> 8 & 0x00FF)+ amt;const B =(num & 0x0000FF)+ amt;return '#' +(0x1000000 +(R < 255 ? R < 1 ? 0:R:255)* 0x10000 +(G < 255 ? G < 1 ? 0:G:255)* 0x100 +(B < 255 ? B < 1 ? 0:B:255)).toString(16).slice(1);}getPositionStyles(){const positions ={'bottom-right':'bottom:24px;right:24px;','bottom-left':'bottom:24px;left:24px;','top-right':'top:24px;right:24px;','top-left':'top:24px;left:24px;',};return positions[this.config.position] || positions['bottom-right'];}createButton(){this.button = document.createElement('button');this.button.className = 'tf-widget-button';this.button.setAttribute('aria-label','Abrir feedback');this.button.innerHTML = ` <svg xmlns="http:<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/> </svg> `;this.button.addEventListener('click',()=> this.openModal());this.shadow.appendChild(this.button);}createModal(){this.overlay = document.createElement('div');this.overlay.className = 'tf-modal-overlay';this.modal = document.createElement('div');this.modal.className = 'tf-modal';this.modal.innerHTML = ` <div class="tf-modal-header"> <div> <h3 class="tf-modal-title">${this.escapeHtml(this.config.title)}</h3> ${this.config.subtitle ? `<p class="tf-modal-subtitle">${this.escapeHtml(this.config.subtitle)}</p>`:''}</div> <button class="tf-close-btn" id="tf-close-${this.host.id}" aria-label="Fechar"> <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="square"> <line x1="18" y1="6" x2="6" y2="18"/> <line x1="6" y1="6" x2="18" y2="18"/> </svg> </button> </div> <div class="tf-modal-body"> <!-- Step 1:NPS --> <div id="tf-step-1-${this.host.id}" class="tf-step"> <p class="tf-step-label">Como você avalia sua experiência?</p> <div class="tf-nps-scale"> ${[0,1,2,3,4,5,6,7,8,9,10].map(n => ` <button class="tf-nps-btn" data-nps="${n}" aria-label="Nota ${n}">${n}</button> `).join('')}</div> <div class="tf-nps-labels"> <span>Pouco provável</span> <span>Muito provável</span> </div> <button class="tf-submit-btn" id="tf-next-1-${this.host.id}" style="margin-top:24px;" disabled>Próximo</button> </div> <!-- Step 2:Feedback Type --> <div id="tf-step-2-${this.host.id}" class="tf-step tf-hidden"> <p class="tf-step-label">Que tipo de feedback você quer compartilhar?</p> <div class="tf-type-buttons"> ${this.config.enableSuggestions ? ` <button class="tf-type-btn" data-type="suggestion"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="square"> <circle cx="12" cy="12" r="5"/> <line x1="12" y1="1" x2="12" y2="3"/> <line x1="12" y1="21" x2="12" y2="23"/> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/> <line x1="1" y1="12" x2="3" y2="12"/> <line x1="21" y1="12" x2="23" y2="12"/> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/> </svg> Sugestão </button> `:''}${this.config.enableBugs ? ` <button class="tf-type-btn" data-type="bug"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="square"> <rect x="8" y="6" width="8" height="12" rx="0"/> <line x1="12" y1="12" x2="12" y2="12.01"/> <path d="M8 8h.01"/> <path d="M16 8h.01"/> <path d="M8 16h.01"/> <path d="M16 16h.01"/> </svg> Bug </button> `:''}</div> <button class="tf-submit-btn" id="tf-next-2-${this.host.id}" disabled>Próximo</button> </div> <!-- Step 3:Feedback Text --> <div id="tf-step-3-${this.host.id}" class="tf-step tf-hidden"> <input type="text" class="tf-title-input" id="tf-title-${this.host.id}" placeholder="Título do feedback(opcional)" maxlength="100" /> <textarea class="tf-textarea" id="tf-feedback-text-${this.host.id}" placeholder="Conte-nos mais detalhes sobre sua experiência..."></textarea> <button class="tf-submit-btn" id="tf-submit-${this.host.id}">Enviar Feedback</button> </div> <!-- Success --> <div id="tf-success-${this.host.id}" class="tf-success tf-hidden"> <svg class="tf-success-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="square"> <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/> <polyline points="22 4 12 14.01 9 11.01"/> </svg> <h3 class="tf-success-title">Obrigado!</h3> <p class="tf-success-message">${this.escapeHtml(this.config.thankYouMessage)}</p> </div> </div> `;this.overlay.appendChild(this.modal);this.shadow.appendChild(this.overlay);this.bindEvents();}bindEvents(){const hostId = this.host.id;const closeBtn = this.shadow.getElementById(`tf-close-${hostId}`);if(closeBtn){closeBtn.addEventListener('click',()=> this.closeModal());}this.overlay.addEventListener('click',(e)=>{if(e.target === this.overlay)this.closeModal();});this.shadow.querySelectorAll('.tf-nps-btn').forEach(btn =>{btn.addEventListener('click',(e)=>{this.selectedNps = parseInt(e.target.dataset.nps);this.shadow.querySelectorAll('.tf-nps-btn').forEach(b => b.classList.remove('selected'));e.target.classList.add('selected');const nextBtn = this.shadow.getElementById(`tf-next-1-${hostId}`);if(nextBtn)nextBtn.disabled = false;});});const next1 = this.shadow.getElementById(`tf-next-1-${hostId}`);if(next1){next1.addEventListener('click',()=>{if(!this.config.enableSuggestions && !this.config.enableBugs){this.goToStep(3);}else{this.goToStep(2);}});}const next2 = this.shadow.getElementById(`tf-next-2-${hostId}`);if(next2){next2.addEventListener('click',()=> this.goToStep(3));}this.shadow.querySelectorAll('.tf-type-btn').forEach(btn =>{btn.addEventListener('click',(e)=>{this.feedbackType = e.currentTarget.dataset.type;this.shadow.querySelectorAll('.tf-type-btn').forEach(b => b.classList.remove('selected'));e.currentTarget.classList.add('selected');const nextBtn = this.shadow.getElementById(`tf-next-2-${hostId}`);if(nextBtn)nextBtn.disabled = false;});});const submitBtn = this.shadow.getElementById(`tf-submit-${hostId}`);if(submitBtn){submitBtn.addEventListener('click',()=> this.submitFeedback());}this.overlay.addEventListener('keydown',(e)=>{if(e.key === 'Escape')this.closeModal();});}openModal(){this.isOpen = true;this.overlay.classList.add('active');document.body.style.overflow = 'hidden';setTimeout(()=>{const firstFocusable = this.shadow.querySelector('button,input,textarea');if(firstFocusable)firstFocusable.focus();},100);}closeModal(){this.isOpen = false;this.overlay.classList.remove('active');document.body.style.overflow = '';setTimeout(()=>{this.resetForm();},250);}goToStep(step){const hostId = this.host.id;this.shadow.querySelectorAll('.tf-step').forEach(el => el.classList.add('tf-hidden'));const stepEl = this.shadow.getElementById(`tf-step-${step}-${hostId}`);if(stepEl)stepEl.classList.remove('tf-hidden');}resetForm(){const hostId = this.host.id;this.currentStep = 1;this.selectedNps = null;this.feedbackType = null;this.feedbackTitle = '';this.shadow.querySelectorAll('.tf-step').forEach(el => el.classList.add('tf-hidden'));const step1 = this.shadow.getElementById(`tf-step-1-${hostId}`);if(step1)step1.classList.remove('tf-hidden');const successEl = this.shadow.getElementById(`tf-success-${hostId}`);if(successEl)successEl.classList.add('tf-hidden');this.shadow.querySelectorAll('.tf-nps-btn').forEach(b => b.classList.remove('selected'));this.shadow.querySelectorAll('.tf-type-btn').forEach(b => b.classList.remove('selected'));const titleInput = this.shadow.getElementById(`tf-title-${hostId}`);if(titleInput)titleInput.value = '';const textArea = this.shadow.getElementById(`tf-feedback-text-${hostId}`);if(textArea)textArea.value = '';const next1 = this.shadow.getElementById(`tf-next-1-${hostId}`);if(next1)next1.disabled = true;const next2 = this.shadow.getElementById(`tf-next-2-${hostId}`);if(next2)next2.disabled = true;}async submitFeedback(){const hostId = this.host.id;const textEl = this.shadow.getElementById(`tf-feedback-text-${hostId}`);const titleEl = this.shadow.getElementById(`tf-title-${hostId}`);const text = textEl ? textEl.value.trim():'';const title = titleEl ? titleEl.value.trim():'';const submitBtn = this.shadow.getElementById(`tf-submit-${hostId}`);if(!text){if(textEl)textEl.focus();return;}if(submitBtn){submitBtn.disabled = true;submitBtn.innerHTML = '<span class="tf-loading"></span>Enviando...';}try{const response = await fetch(`${CONFIG.apiUrl}/api/widget/feedback`,{method:'POST',headers:{'Content-Type':'application/json','X-API-Key':this.config.apiKey,},body:JSON.stringify({project_id:this.config.projectId,type:this.feedbackType || 'suggestion',nps_score:this.selectedNps,content:text,title:title || null,page_url:window.location.href,user_agent:navigator.userAgent,}),});if(response.ok){this.shadow.querySelectorAll('.tf-step').forEach(el => el.classList.add('tf-hidden'));const successEl = this.shadow.getElementById(`tf-success-${hostId}`);if(successEl)successEl.classList.remove('tf-hidden');setTimeout(()=> this.closeModal(),3000);}else{const errorData = await response.json().catch(()=>({}));throw new Error(errorData.error || 'Failed to submit');}}catch(error){console.error('TinyFeedback:',error);if(submitBtn){submitBtn.disabled = false;submitBtn.textContent = 'Enviar Feedback';}alert('Erro ao enviar feedback. Tente novamente.');}}escapeHtml(text){if(!text)return '';const div = document.createElement('div');div.textContent = text;return div.innerHTML;}}async function initWidget(){const scripts = document.querySelectorAll('script[data-widget-key]');for(const script of scripts){const widgetKey = script.dataset.widgetKey;if(!widgetKey)continue;if(script.dataset.initialized === 'true')continue;script.dataset.initialized = 'true';try{const response = await fetch(`${CONFIG.apiUrl}/api/widget/${encodeURIComponent(widgetKey)}/config`);if(!response.ok){throw new Error(`Failed to load widget config:${response.status}`);}const config = await response.json();const widget = new TinyFeedbackWidget(config);widgetInstances.set(widgetKey,widget);console.log('TinyFeedback:Widget initialized for key:',widgetKey);}catch(err){console.error('TinyFeedback:Failed to initialize widget:',err);}}}if(document.readyState === 'loading'){document.addEventListener('DOMContentLoaded',initWidget);}else{initWidget();}window.TinyFeedback ={init:initWidget,Widget:TinyFeedbackWidget,version:'1.0.0',};})();